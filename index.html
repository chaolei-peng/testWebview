<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Engagement Time æµ‹è¯•2</title>

    <!-- Google tag (gtag.js) - å…¨å±€ Debug æ¨¡å¼ -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PFRLSPSK3L"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        // å¼€å¯å…¨å±€ Debug æ¨¡å¼ï¼Œæ‰€æœ‰äº‹ä»¶éƒ½ä¼šå‘é€åˆ° DebugView
        gtag('config', 'G-PFRLSPSK3L', { 'debug_mode': true });
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 22px;
            text-align: center;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            backdrop-filter: blur(10px);
        }

        .label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .value {
            font-size: 28px;
            font-weight: bold;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status.visible {
            background: #4ade80;
            color: #000;
        }

        .status.hidden {
            background: #f87171;
            color: #fff;
        }

        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 16px;
            font-family: monospace;
            font-size: 11px;
            max-height: 250px;
            overflow-y: auto;
        }

        .log-item {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .time {
            opacity: 0.6;
        }

        .firebase-tag {
            background: #FFA000;
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-right: 4px;
        }

        .info-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            font-size: 12px;
            margin-top: 16px;
        }

        .info-box h3 {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .info-box ul {
            padding-left: 16px;
        }

        .info-box li {
            margin: 4px 0;
        }

        .sdk-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .sdk-status.loading {
            background: #fbbf24;
            color: #000;
        }

        .sdk-status.ready {
            background: #4ade80;
            color: #000;
        }

        .sdk-status.error {
            background: #f87171;
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ“Š Firebase Engagement æµ‹è¯•</h1>

        <div class="card">
            <div class="label">Firebase SDK çŠ¶æ€</div>
            <span id="sdkStatus" class="sdk-status loading">åŠ è½½ä¸­...</span>
        </div>

        <div class="card">
            <div class="label">é¡µé¢çŠ¶æ€</div>
            <span id="status" class="status visible">VISIBLE</span>
        </div>

        <div class="card">
            <div class="label">ç´¯è®¡å¯è§æ—¶é•¿ï¼ˆæœ¬åœ°è®¡ç®—ï¼‰</div>
            <div class="value"><span id="engagementTime">0.0</span>s</div>
        </div>

        <div class="card">
            <div class="label">visibility å˜åŒ–æ¬¡æ•°</div>
            <div class="value"><span id="changeCount">0</span></div>
        </div>

        <div class="card">
            <div class="label">äº‹ä»¶æ—¥å¿—</div>
            <div class="log" id="log"></div>
        </div>

        <div class="info-box">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <ul>
                <li>åœ¨ Firebase Console â†’ DebugView å®æ—¶æŸ¥çœ‹äº‹ä»¶</li>
                <li><span class="firebase-tag">FB</span> æ ‡è®°çš„æ˜¯å‘é€åˆ° Firebase çš„äº‹ä»¶</li>
                <li>æµ‹è¯•æ­¥éª¤ï¼šæ‰“å¼€é¡µé¢ â†’ æŒ‰ Home é”® â†’ é¡µé¢æ¢å¤ â†’ æŸ¥çœ‹æ—¥å¿—</li>
            </ul>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAnalytics, logEvent, setAnalyticsCollectionEnabled } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";

        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAaX4978AFuTrPqOFUncHAjyA8N6GfqRgk",
            authDomain: "testweb-5bcbf.firebaseapp.com",
            projectId: "testweb-5bcbf",
            storageBucket: "testweb-5bcbf.firebasestorage.app",
            messagingSenderId: "15226321954",
            appId: "1:15226321954:web:39c116ed64fd84fbb0de7b",
            measurementId: "G-PFRLSPSK3L"
        };

        // çŠ¶æ€å˜é‡
        let engagementTime = 0;
        let lastVisibleTime = Date.now();
        let isVisible = true;
        let changeCount = 0;
        let analytics = null;
        const sessionId = 'test_' + Date.now();
        const pageLoadTime = Date.now();

        // æ·»åŠ æ—¥å¿—
        function addLog(message, isFirebase = false) {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false, fractionalSecondDigits: 3 });
            const item = document.createElement('div');
            item.className = 'log-item';
            const fbTag = isFirebase ? '<span class="firebase-tag">FB</span>' : '';
            item.innerHTML = `<span class="time">[${time}]</span> ${fbTag}${message}`;
            log.insertBefore(item, log.firstChild);
            console.log(`[EngagementTest] ${message}`);
        }

        // å‘é€ Firebase äº‹ä»¶
        function sendFirebaseEvent(eventName, params = {}) {
            if (!analytics) {
                addLog(`âš ï¸ SDK æœªå°±ç»ªï¼Œæ— æ³•å‘é€: ${eventName}`);
                return;
            }
            try {
                const ua = navigator.userAgent;
                const isWebView = ua.includes('wv') || ua.includes('WebView') ||
                    (ua.includes('Android') && !ua.includes('Chrome'));

                logEvent(analytics, eventName, {
                    ...params,
                    session_id: sessionId,
                    page_time_ms: Date.now() - pageLoadTime,
                    user_agent: ua.substring(0, 100),  // æˆªå–å‰100å­—ç¬¦ï¼Œé¿å…è¿‡é•¿
                    is_webview: isWebView,
                    debug_mode: true
                });
                addLog(`âœ… ${eventName}`, true);
            } catch (e) {
                addLog(`âŒ å‘é€å¤±è´¥: ${e.message}`);
            }
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            if (isVisible) {
                const now = Date.now();
                const currentEngagement = engagementTime + (now - lastVisibleTime);
                document.getElementById('engagementTime').textContent = (currentEngagement / 1000).toFixed(1);
            }
        }

        // åˆå§‹åŒ– Firebase
        try {
            const app = initializeApp(firebaseConfig);
            analytics = getAnalytics(app);

            // å¼€å¯è°ƒè¯•æ¨¡å¼ï¼ˆéœ€è¦åœ¨ URL ä¸­æ·»åŠ  ?debug æˆ–ä½¿ç”¨ Chrome æ‰©å±•ï¼‰
            setAnalyticsCollectionEnabled(analytics, true);

            document.getElementById('sdkStatus').textContent = 'å·²å°±ç»ª âœ“';
            document.getElementById('sdkStatus').className = 'sdk-status ready';
            addLog('ğŸ”¥ Firebase SDK åˆå§‹åŒ–æˆåŠŸ');

            // å‘é€é¡µé¢åŠ è½½äº‹ä»¶
            sendFirebaseEvent('test_page_load', {
                timestamp: Date.now()
            });

        } catch (e) {
            document.getElementById('sdkStatus').textContent = 'åˆå§‹åŒ–å¤±è´¥';
            document.getElementById('sdkStatus').className = 'sdk-status error';
            addLog(`âŒ Firebase åˆå§‹åŒ–å¤±è´¥: ${e.message}`);
        }

        // ç›‘å¬ visibility å˜åŒ–
        document.addEventListener('visibilitychange', function () {
            const now = Date.now();
            changeCount++;
            document.getElementById('changeCount').textContent = changeCount;

            if (document.visibilityState === 'hidden') {
                // é¡µé¢å˜ä¸ºä¸å¯è§
                const visibleDuration = isVisible ? (now - lastVisibleTime) : 0;
                if (isVisible) {
                    engagementTime += visibleDuration;
                    isVisible = false;
                }

                document.getElementById('status').textContent = 'HIDDEN';
                document.getElementById('status').className = 'status hidden';
                document.getElementById('engagementTime').textContent = (engagementTime / 1000).toFixed(1);

                addLog(`ğŸ”´ HIDDEN - æœ¬æ¬¡ ${(visibleDuration / 1000).toFixed(2)}s, ç´¯è®¡ ${(engagementTime / 1000).toFixed(2)}s`);

                // å‘é€äº‹ä»¶åˆ° Firebase
                sendFirebaseEvent('visibility_hidden', {
                    visible_duration_ms: Math.round(visibleDuration),
                    total_engagement_ms: Math.round(engagementTime),
                    change_count: changeCount
                });

            } else {
                // é¡µé¢å˜ä¸ºå¯è§
                lastVisibleTime = now;
                isVisible = true;
                document.getElementById('status').textContent = 'VISIBLE';
                document.getElementById('status').className = 'status visible';

                addLog(`ğŸŸ¢ VISIBLE - æ¢å¤è®¡æ—¶`);

                // å‘é€äº‹ä»¶åˆ° Firebase
                sendFirebaseEvent('visibility_visible', {
                    total_engagement_ms: Math.round(engagementTime),
                    change_count: changeCount
                });
            }
        });

        // é¡µé¢å¸è½½æ—¶å‘é€æœ€ç»ˆæ•°æ®
        window.addEventListener('pagehide', function () {
            if (isVisible) {
                engagementTime += (Date.now() - lastVisibleTime);
            }
            sendFirebaseEvent('page_unload', {
                final_engagement_ms: Math.round(engagementTime),
                change_count: changeCount
            });
        });

        // æ¯ 100ms æ›´æ–°æ˜¾ç¤º
        setInterval(updateDisplay, 100);

        // åˆå§‹æ—¥å¿—
        addLog('ğŸ“± é¡µé¢å·²åŠ è½½');
        addLog(`ğŸ“‹ visibilityState: ${document.visibilityState}`);

        // ç¯å¢ƒè¯Šæ–­
        const ua = navigator.userAgent;
        const isWebView = ua.includes('wv') || ua.includes('WebView') ||
            (ua.includes('Android') && !ua.includes('Chrome'));
        addLog(`ğŸ“± ç¯å¢ƒ: ${isWebView ? 'WebView' : 'æµè§ˆå™¨'}`);
        addLog(`ğŸª Cookie å¯ç”¨: ${navigator.cookieEnabled}`);
        addLog(`ğŸ’¾ localStorage: ${typeof localStorage !== 'undefined' ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}`);

        // æ£€æŸ¥ gtag æ˜¯å¦å¯ç”¨
        setTimeout(() => {
            if (typeof gtag === 'function') {
                addLog('âœ… gtag å‡½æ•°å¯ç”¨');
            } else {
                addLog('âŒ gtag å‡½æ•°ä¸å¯ç”¨ï¼å¯èƒ½è¢« WebView é˜»æ­¢');
            }

            // æ£€æŸ¥ dataLayer
            if (window.dataLayer && window.dataLayer.length > 0) {
                addLog(`âœ… dataLayer æœ‰ ${window.dataLayer.length} æ¡æ•°æ®`);
            } else {
                addLog('âš ï¸ dataLayer ä¸ºç©ºæˆ–ä¸å­˜åœ¨');
            }
        }, 2000);
    </script>


    <!-- é¡µé¢å¯è§æ€§ç›‘æ§ï¼šæ¯ç§’æ‰“å°é¡µé¢çŠ¶æ€/ç´¯è®¡å¯è§æ—¶é•¿ï¼ˆç”¨äº WebView + Logcat æ’æŸ¥ï¼‰ -->
    <script>
        (function () {
            var TAG = "[PAGE_VIS]";
            var startPerf = (window.performance && performance.now) ? performance.now() : Date.now();
            var visible = false;
            var lastVisibleStart = null;
            var totalVisibleMs = 0;
            var tick = 0;

            function nowPerf() {
                return (window.performance && performance.now) ? performance.now() : Date.now();
            }

            // â€œå¯è§â€å®šä¹‰ï¼šdocument å¯è§ + é¡µé¢æœ‰ç„¦ç‚¹ï¼ˆåœ¨ WebView é‡Œæ›´è´´è¿‘ç”¨æˆ·çœŸå®å¯è§ï¼‰
            function isVisibleNow() {
                var visibilityOk = (typeof document.visibilityState === "string")
                    ? (document.visibilityState === "visible")
                    : (!document.hidden);

                var focusOk = (typeof document.hasFocus === "function") ? document.hasFocus() : true;

                return visibilityOk && focusOk;
            }

            function flushVisibilityChange(reason) {
                var t = nowPerf();
                var v = isVisibleNow();

                if (v && !visible) {
                    visible = true;
                    lastVisibleStart = t;
                    console.log(TAG + " state -> VISIBLE (" + reason + ")");
                } else if (!v && visible) {
                    visible = false;
                    if (lastVisibleStart != null) {
                        totalVisibleMs += (t - lastVisibleStart);
                    }
                    lastVisibleStart = null;
                    console.log(TAG + " state -> NOT_VISIBLE (" + reason + ")");
                }
            }

            function getTotalVisibleMs() {
                var t = nowPerf();
                var live = (visible && lastVisibleStart != null) ? (t - lastVisibleStart) : 0;
                return totalVisibleMs + live;
            }

            // ç›‘å¬æ‰€æœ‰å¯èƒ½å½±å“å¯è§æ€§çš„äº‹ä»¶
            var events = ["visibilitychange", "focus", "blur", "pageshow", "pagehide"];
            events.forEach(function (ev) {
                window.addEventListener(ev, function () {
                    flushVisibilityChange(ev);
                }, true);
            });

            // æŸäº›å†…æ ¸æ”¯æŒ freeze/resumeï¼ˆå¯é€‰ï¼‰
            try {
                window.addEventListener("freeze", function () { flushVisibilityChange("freeze"); }, true);
                window.addEventListener("resume", function () { flushVisibilityChange("resume"); }, true);
            } catch (e) { /* ignore */ }

            // åˆå§‹åŒ–ä¸€æ¬¡
            flushVisibilityChange("init");

            // æ¯ç§’æ‰“å°ä¸€æ¬¡çŠ¶æ€
            setInterval(function () {
                tick++;
                var t = nowPerf();
                var elapsedMs = t - startPerf;
                var visMs = getTotalVisibleMs();

                var payload = {
                    tick: tick,
                    ts: Date.now(),
                    pageState: visible ? "VISIBLE" : "NOT_VISIBLE",
                    visibilityState: document.visibilityState,
                    hidden: document.hidden,
                    hasFocus: (typeof document.hasFocus === "function") ? document.hasFocus() : null,
                    elapsedMs: Math.round(elapsedMs),
                    visibleTotalMs: Math.round(visMs),
                    visibleTotalSec: +(visMs / 1000).toFixed(3)
                };

                // Android Studio / Logcatï¼šç¡®ä¿ WebView è®¾ç½®äº† WebChromeClient æ‰èƒ½çœ‹åˆ° console.log
                console.log(TAG, JSON.stringify(payload));
            }, 1000);
        })();
    </script>

</body>

</html>
